<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì - ìƒí’ˆ ë“±ë¡</title>

  <!-- ê¸°ë³¸ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" th:href="@{/css/admin/notice/notice.css}">
  <th:block th:replace="~{components/admin/external :: external}"></th:block>

  <style>
    .form-container {
      width: 900px;
      margin: 0 auto;
      padding: 40px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .form-row {
      display: flex;
      margin-bottom: 24px;
      align-items: flex-start;
    }

    .form-label {
      width: 160px;
      font-weight: 600;
      padding-top: 8px;
    }

    .form-field {
      flex: 1;
    }

    input[type="text"],
    input[type="number"],
    textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    textarea {
      height: 160px;
    }

    .radio-group,
    .checkbox-group {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    .button-group {
      text-align: center;
      margin-top: 40px;
    }

    .btn {
      padding: 12px 36px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-submit {
      background-color: #2563eb;
      color: white;
    }

    .btn-cancel {
      background: transparent;
      border: 1px solid #ccc;
      margin-left: 12px;
    }

    .image-preview-box {
      display: flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .image-wrapper {
      position: relative;
      width: 80px;
      height: 80px;
    }

    .image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .delete-image {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 20px;
      height: 20px;
      background: black;
      color: white;
      text-align: center;
      line-height: 20px;
      font-size: 12px;
      border-radius: 50%;
      cursor: pointer;
    }

    .upload-box {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .upload-box img {
      width: 80px;
      height: 80px;
      cursor: pointer;
    }

    .image-count-box {
      font-size: 14px;
      color: #666;
    }
    
    /* input number í™”ì‚´í‘œ ì œê±° (ëª¨ë“  ë¸Œë¼ìš°ì €ìš©) */
	input[type=number]::-webkit-inner-spin-button,
	input[type=number]::-webkit-outer-spin-button {
	  -webkit-appearance: none;
	  margin: 0;
	}
	input[type=number] {
	  -moz-appearance: textfield;
	}
	
  </style>
</head>

<body style="background: #f3f4f6">
  <div th:replace="~{fragments/admin/admin_sidebar :: sidebar}"></div>

  <div class="admin-wrapper">
    <div class="main-content">
      <header class="main-header">
        <div class="breadcrumbs">
          <span>ê¸°ì—…ê´€ ê´€ë¦¬ &gt;</span> <span class="current-page">ìƒí’ˆ ë“±ë¡</span>
        </div>
      </header>

      <main>
        <div class="form-container">
          <form th:action="@{/admin/planing/planingDetail}" th:object="${productDTO}"
						      method="post"
						      enctype="multipart/form-data"
						      onsubmit="return false">
						      
	      <input type="hidden" th:field="*{prdNum}"/>
		  <input type="hidden" th:field="*{imgNum}"/>
		  <input type="hidden" th:field="*{userNum}"/>
		  <input type="hidden" th:field="*{comNum}"/>
		  
            <!-- ì´ë¯¸ì§€ ì—…ë¡œë“œ -->
            <div class="form-row">
              <div class="form-label">ì´ë¯¸ì§€</div>
              <div class="form-field">
                <div class="upload-box">
                  <label for="image-upload-input">
                    <img src="/images/upload.png" alt="ì—…ë¡œë“œ ë²„íŠ¼">
                  </label>
                  <input type="file" id="image-upload-input" name="images" accept="images/*" multiple style="display: none;">
                  <div class="image-count-box"><span id="image-count">0/5</span></div>
                </div>
                <div id="image-preview-box" class="image-preview-box">
                <img th:if="${imageDTO != null}" th:src="@{${imageDTO.mainImage}}" alt="ë©”ì¸ ì´ë¯¸ì§€" width="200">
				  <img th:if="${imageDTO.subImage1 != null}" th:src="@{${imageDTO.subImage1}}" alt="ì„œë¸Œ1" width="100">
				  <img th:if="${imageDTO.subImage2 != null}" th:src="@{${imageDTO.subImage2}}" alt="ì„œë¸Œ2" width="100">
				  <img th:if="${imageDTO.subImage3 != null}" th:src="@{${imageDTO.subImage3}}" alt="ì„œë¸Œ3" width="100">
				  <img th:if="${imageDTO.subImage4 != null}" th:src="@{${imageDTO.subImage4}}" alt="ì„œë¸Œ4" width="100">
                </div>
              </div>
            </div>

            <!-- ì œëª© -->
            <div class="form-row">
              <label for="title" class="form-label">ì œëª©</label>
              <div class="form-field">
                <input type="text" id="title" th:field="*{title}" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
              </div>
            </div>

            <!-- ë‚´ìš© -->
            <div class="form-row">
              <label for="content" class="form-label">ë‚´ìš©</label>
              <div class="form-field">
                <textarea id="content" th:field="*{content}" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
              </div>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ -->
            <div class="form-row">
              <div class="form-label">ì¹´í…Œê³ ë¦¬</div>
              <div class="form-field radio-group">
                <label th:each="cat : ${categories}">
				  <input type="radio" th:field="*{catNum}" th:value="${cat.catNum}" />
				  <span th:text="${cat.name}"></span>
				</label>
              </div>
            </div>

            <!-- ê°€ê²© -->
            <div class="form-row">
			  <label for="price" class="form-label">ê°€ê²©</label>
			  <div class="form-field">
			    <input type="text" id="price" name="price" th:field="*{price}" placeholder="ì˜ˆ: 10,000 ì›" style="width: 200px;">
			    <div id="price-error" style="color:red; display:none;">ê°€ê²©ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.</div>
			  </div>
			</div>
			
			<!-- ì¬ê³  -->
            <div class="form-row">
			  <label for="prdCnt" class="form-label">ì¬ê³ </label>
			  <div class="form-field">
			    <input type="text" id="prdCnt" name="prdCnt" th:field="*{prdCnt}" style="width: 200px;">
			  </div>
			</div>

            <!-- ê±°ë˜ ë°©ë²• -->
            <div class="form-row">
              <div class="form-label">ê±°ë˜ ë°©ë²•</div>
              <div class="form-field checkbox-group">
                <label><input type="checkbox" value="íƒë°°ê±°ë˜" id="delivery" th:field="*{deliveryType}"> íƒë°°ê±°ë˜</label>
                <div id="trade-method-error" style="color:red; display:none;">ê±°ë˜ ë°©ë²•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</div>
              </div>
            </div>

            <!-- íŒë§¤ ìƒíƒœ -->
            <div class="form-row">
			  <div class="form-label">íŒë§¤ ìƒíƒœ</div>
			  <div class="form-field radio-group">
			    <label><input type="radio" name="sellType" value="Y" th:field="*{sellType}"> íŒë§¤ì¤‘</label>
			    <label><input type="radio" name="sellType" value="N" th:field="*{sellType}"> ë§¤ì§„</label>
			  </div>
			</div>
			
			<div class="form-row">
			  <div class="form-label">ë…¸ì¶œ ì—¬ë¶€</div>
			  <div class="form-field radio-group">
			    <label><input type="radio" name="hiddenType" value="N" th:field="*{hiddenType}"> ë…¸ì¶œ</label>
			    <label><input type="radio" name="hiddenType" value="Y" th:field="*{hiddenType}"> ìˆ¨ê¹€</label>
			  </div>
			</div>

			
            <!-- ë²„íŠ¼ -->
            <div class="button-group">
              <button type="button" class="btn btn-submit" id="update-btn">ìˆ˜ì •</button>
              <a href="javascript:history.back()" class="btn btn-cancel" style="text-decoration: none; cursor: pointer; color: inherit;">ì·¨ì†Œ</a>
            </div>
          </form>
        </div>
      </main>
    </div>
  </div>

  <script src="/js/admin/script.js" defer></script>
  <script>
    $(function () {
    	
		//ì´ë¯¸ì§€
      let imageFiles = [];

      $('#image-upload-input').on('change', function (e) {
        const files = Array.from(e.target.files);
        if (imageFiles.length + files.length > 5) {
          alert('ìµœëŒ€ 5ì¥ê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
          return;
        }
        imageFiles = imageFiles.concat(files);
        updatePreview();
      });

      function updatePreview() {
        const previewBox = $('#image-preview-box').empty();
        $('#image-count').text(`${imageFiles.length}/5`);
        imageFiles.forEach((file, i) => {
          const reader = new FileReader();
          reader.onload = function (e) {
            const wrapper = $('<div>').addClass('image-wrapper');
            const img = $('<img>').attr('src', e.target.result);
            const del = $('<div>').addClass('delete-image').text('Ã—').attr('data-index', i);
            wrapper.append(img).append(del);
            previewBox.append(wrapper);
          };
          reader.readAsDataURL(file);
        });
      }

      $(document).on('click', '.delete-image', function () {
        const index = $(this).data('index');
        imageFiles.splice(index, 1);
        updatePreview();
      });
      
      const rawPrdCnt = $('#prdCnt').val().replace(/[^0-9]/g, '');
      const prdCntValue = Number(rawPrdCnt);
      if (isNaN(prdCntValue) || prdCntValue < 0 || prdCntValue > 99999) {
        alert("ì¬ê³ ëŠ” 0ê°œ ì´ìƒ 99,999ê°œ ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        $('#prdCnt').focus();
        return;
      }
      
      //ê°€ê²©í‘œì‹œ
      const $priceInput = $('#price');
      const $form = $('form');

      // ì…ë ¥ ì‹œ: ìˆ«ìë§Œ ë°›ì•„ì„œ , ë‹¨ìœ„ ë° "ì›" ë¶™ì´ê¸°
      $priceInput.on('input', function () {
        let value = $(this).val().replace(/[^0-9]/g, '');
        if (value === '') {
          $(this).val('');
          return;
        }
        $(this).val(Number(value).toLocaleString('ko-KR') + ' ì›');
      });

      // í¬ì»¤ìŠ¤ ì‹œ: ìˆ«ìë§Œ ë‚¨ê¸°ê¸° (í¸ì§‘ ëª¨ë“œ)
      $priceInput.on('focus', function () {
        let value = $(this).val().replace(/[^0-9]/g, '');
        $(this).val(value);
      });

      // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œ: í¬ë§· ë‹¤ì‹œ ì ìš©
      $priceInput.on('blur', function () {
        let value = $(this).val().replace(/[^0-9]/g, '');
        if (value !== '') {
          $(this).val(Number(value).toLocaleString('ko-KR') + ' ì›');
        }
      });

      // í¼ ì „ì†¡ ì‹œ: ìˆ«ìë§Œ ë‚¨ê²¨ì„œ ì„œë²„ë¡œ ì „ì†¡
      $form.on('submit', function () {
        let raw = $priceInput.val().replace(/[^0-9]/g, '');
        $priceInput.val(raw);
        
      });
      
      $('#update-btn').on('click', function () {
    	    const rawPrice = $('#price').val().replace(/[^0-9]/g, '');

    	    const product = {
    	        prdNum: $('[name="prdNum"]').val(),
    	        imgNum: $('[name="imgNum"]').val(),
    	        userNum: $('[name="userNum"]').val(),
    	        comNum: $('[name="comNum"]').val(),
    	        title: $('#title').val(),
    	        content: $('#content').val(),
    	        price: rawPrice,
    	        prdCnt: prdCntValue,
    	        catNum: $("input[name='catNum']:checked").val(),
    	        deliveryType: $('#delivery').is(':checked') ? 'Y' : 'N',
    	        sellType: $("input[name='sellType']:checked").val() || 'Y',
    	        hiddenType: $("input[name='hiddenType']:checked").val() || 'N',
    	        safeType: 'N',
    	        meetType: 'N',
    	        appointType: 'N'
    	    };

    	    const formData = new FormData();
    	    formData.append("product", new Blob([JSON.stringify(product)], {type:"application/json"}));
    	    imageFiles.forEach(f => formData.append("images", f));

    	    $.ajax({
    	        url: "/admin/planing/planingDetail", // ğŸ’¡ POSTë¡œ ì¬ì‚¬ìš©
    	        method: "POST",
    	        data: formData,
    	        processData: false,
    	        contentType: false,
    	        success: () => location.href = "/admin/planing/planingList",
    	        error: xhr => console.log(xhr)
    	    });
    	});
      
      
      
      
    });
  </script>
</body>
</html>

